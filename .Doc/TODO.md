# Work To be done & optimized

- **待完成**：不完成可能导致整车功能不完整
- **待优化**：对已有的功能进行性能提高/模块解耦/可维护性增强
- **待添加**：不紧急的/锦上添花的功能

**==标为黄色高亮的代表紧急程度高。==**

## assorted

- [ ] 由于我们读写和传递的数据结构都不大，基本不会发生读写时任务切换的情况。典型的数据读写时间都是~μs，故没有对数据访问的接口添加互斥锁或关闭全局中断。后续有需求（如大量数据复制）可以添加。可以新增一个bsp_mutex或者module层的ds，提供相应支持。实际上freertos提供了一些供线程（任务）间进行数据交互的类型和函数，请查阅对应文档。

最简单的防止重入或数据竞争的方式是创建一个bool类型值实现互斥访问。当一个线程或中断要访问某个变量时，先检查这个变量对应的bool锁是否为1，若不为1则赋值为1表明当前有线程访问变量，之后可以开始对该变量的操作，结束读写后释放锁即赋0。不像osSemaphore或osMessageQueue等只允许在中断中添加消息或释放信号量/互斥量，这种变量锁可以在任意处加锁解锁。

若锁获取失败，则直接退出，或将当前线程挂起等待下一次唤醒。最常见的情况是一个线程需要从一块数据区或缓冲区读取数据而某个中断会向这个区域写入数据，线程在读取的时候很可能会被中断打断。那么中断进入时发现该数据已经被上锁，就不会强行写入。为了保证数据的实时性，你可以选择将数据存入队列或启动一个新的任务，当锁释放时再写入数据。如果数据量较小，你不在乎开销，则可以使用freerots提供的osMessageQueue或osMessageMailbox。

目前，我们在bsp_dwt中添加了一个位锁，防止中断中调用DWTGetDeltaT或DWTGetTimeline函数更新DWT维护的时间时打断任务中的相同函数导致计数被重复更新，或引起错误的DWT溢出检测。

## BSP

### 待完成


### 待优化


### 待添加


---

## Module

### 待完成

#### referee_task

- [ ] 删除不需要的底盘、云台模式的枚举值，并增加新的模式

### 待优化


### 待添加


---

## APP

### 待完成

#### robot_cmd
- [x] 后续增加键鼠控制 
> tip：同时开始键鼠和遥控器设置会导致键鼠和遥控器不能同时控制，原因是后一个控制器会覆盖前一个控制器，致使前一个控制器数据失效

#### upper
- [ ] 机械臂解算
- [ ] 机械臂轨迹规划
- [ ] 增加绝对值编码器

### 待优化

#### robot_cmd

- [x] 遥控器未连接时机器人进入紧急停止状态（利用deamon）
- [ ] robot_state 是否可删除

#### upper

- [ ] 差速器roll轴旋转有偏差
> tip: 大概率同步带太松的原因

#### gimbal


#### chassis

- [ ] 根据IMU的数据对电机实际速度进行融合
